### INSTALL Elasticsearch
wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -
apt install apt-transport-https
echo "deb https://artifacts.elastic.co/packages/8.x/apt stable main" | tee -a /etc/apt/sources.list.d/elastic-8.x.list
apt update && apt install elasticsearch
systemctl daemon-reload
systemctl enable elasticsearch.service
systemctl start elasticsearch.service
systemctl status elasticsearch.service
# curl -k --user elastic:'*4=uJmHoNNv_z+Z+h6_0' https://127.0.0.1:9200
# Reset the password of the elastic built-in superuser with
# /usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic
# Generate an enrollment token for Kibana instances with
# /usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s kibana
# Generate an enrollment token for Elasticsearch nodes with
# /usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s node

### CONFIGURE Elasticsearch
vim /etc/elasticsearch/elasticsearch.yml
path.data: /var/lib/elasticsearch # директория для хранения данных
network.host: 127.0.0.1 # слушаем только локальный интерфейс
http.host: 127.0.0.1 # слушаем только локальный интерфейс
discovery.seed_hosts: ["127.0.0.1", "[::1]"]
sed -i "s|#network.host: 192.168.0.1|network.host: 127.0.0.1|" /etc/elasticsearch/elasticsearch.yml
sed -i "s|http.host: 0.0.0.0|http.host: 127.0.0.1|" /etc/elasticsearch/elasticsearch.yml
systemctl restart elasticsearch.service
# netstat -tulnp | grep 9200

### INSTALL Kibana
wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | apt-key add -
echo "deb https://artifacts.elastic.co/packages/8.x/apt stable main" | tee -a /etc/apt/sources.list.d/elastic-8.x.list
apt update && apt install kibana
systemctl daemon-reload
systemctl enable kibana.service
systemctl start kibana.service
systemctl status kibana.service
# netstat -tulnp | grep 5601

### CONFIGURE kibana
#new pass
/usr/share/elasticsearch/bin/elasticsearch-reset-password -u kibana_system
vi /etc/kibana/kibana.yml
server.publicBaseUrl: "http://172.16.240.240:5601/"
elasticsearch.username: "kibana_system"
elasticsearch.password: "fcO3WzHQ7Paz-lNK=Gvd"
elasticsearch.ssl.certificateAuthorities: [ "/etc/kibana/certs/http_ca.crt" ]
elasticsearch.hosts: ["https://localhost:9200"]
cp -R /etc/elasticsearch/certs /etc/kibana
chown -R root:kibana /etc/kibana/certs
systemctl restart kibana.service
http://172.16.240.240:5601
http://192.168.222.192:8001/

### INSTALL Logstash
apt install logstash
systemctl enable logstash.service
cd /etc/logstash/conf.d
vim input.conf
input {
  beats {
    port => 5044
  }
}
vim output.conf
output {
    if "winsrv" in [tags] {
        elasticsearch {
            hosts     => "https://localhost:9200"
            index    => "winsrv-%{+YYYY.MM.dd}"
        }
    }
    else {
        elasticsearch {
            hosts     => "https://localhost:9200"
            index    => "unknown_messages"
        }
    }
}

cp -R /etc/elasticsearch/certs /etc/logstash
chown -R root:logstash /etc/logstash/certs
vim filter.conf
filter {
 if [type] == "nginx_access" {
    grok {
        match => { "message" => "%{IPORHOST:remote_ip} - %{DATA:user} \[%{HTTPDATE:access_time}\] \"%{WORD:http_method} %{DATA:url} HTTP/%{NUMBER:http_version}\" %{NUMBER:response_code} %{NUMBER:body_sent_bytes} \"%{DATA:referrer}\" \"%{DATA:agent}\"" }
    }
  }
  date {
        match => [ "timestamp" , "dd/MMM/YYYY:HH:mm:ss Z" ]
  }
  geoip {
         source => "remote_ip"
         target => "geoip"
         add_tag => [ "nginx-geoip" ]
  }
}
# https://grokdebug.herokuapp.com/


### INSTALL Winlogbeat
# Download MSI and install
https://www.elastic.co/downloads/beats/winlogbeat
# create file winlogbeat.yml
winlogbeat.event_logs:
  - name: Application
    ignore_older: 72h
  - name: Security
  - name: System

tags: ["winsrv"]

output.logstash:
  hosts: ["10.20.1.56:5044"]

logging.level: info
logging.to_files: true
logging.files:
  path: C:/ProgramData/Elastic/Beats/winlogbeat
  name: winlogbeat.log
  keepfiles: 7


systemctl start logstash.service




https://serveradmin.ru/ustanovka-i-nastroyka-elasticsearch-logstash-kibana-elk-stack/
