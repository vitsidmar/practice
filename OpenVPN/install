sudo apt update && apt upgrade -y
sudo apt install -y openvpn easy-rsa
mkdir ~/easy-rsa
ln -s /usr/share/easy-rsa/* ~/easy-rsa/
sudo chown $USER ~/easy-rsa
chmod 700 ~/easy-rsa

cat > ~/easy-rsa/vars << EOL
set_var EASYRSA_ALGO "ec"
set_var EASYRSA_DIGEST "sha512"
EOL
cd ~/easy-rsa
~/easy-rsa/easyrsa init-pki
~/easy-rsa/easyrsa build-ca

~/easy-rsa/easyrsa gen-req $(uname -n) nopass
cp ~/easy-rsa/pki/private/$(uname -n).key /etc/openvpn/server/
~/easy-rsa/easyrsa sign-req server $(uname -n)
cp ~/easy-rsa/pki/issued/$(uname -n).crt /etc/openvpn/server
cp ~/easy-rsa/pki/ca.crt /etc/openvpn/server
openvpn --genkey secret ta.key
cp ta.key /etc/openvpn/server
# check keys SRV-VPN.crt  SRV-VPN.key  ca.crt ta.key
sudo ls /etc/openvpn/server

mkdir -p ~/client-configs/keys
chmod -R 700 ~/client-configs
cd ~/easy-rsa
./easyrsa gen-req client001 nopass
cp ~/easy-rsa/pki/private/client001.key ~/client-configs/keys/
./easyrsa sign-req client client001
cp ~/easy-rsa/ta.key ~/client-configs/keys/
cp /etc/openvpn/server/ca.crt ~/client-configs/keys/
cp ~/easy-rsa/pki/issued/client001.crt ~/client-configs/keys/
sudo chown $USER.$USER ~/client-configs/keys/*
mkdir -p ~/client-configs/files
echo " " > ~/client-configs/base.conf
# config file https://github.com/OpenVPN/openvpn/blob/master/sample/sample-config-files/client.conf
cat >  ~/client-configs/make_config.sh << EOL
#!/bin/bash
# First argument: Client identifier
KEY_DIR=~/client-configs/keys
OUTPUT_DIR=~/client-configs/files
BASE_CONFIG=~/client-configs/base.conf
cat ${BASE_CONFIG} \
    <(echo -e '<ca>') \
    ${KEY_DIR}/ca.crt \
    <(echo -e '</ca>\n<cert>') \
    ${KEY_DIR}/${1}.crt \
    <(echo -e '</cert>\n<key>') \
    ${KEY_DIR}/${1}.key \
    <(echo -e '</key>\n<tls-crypt>') \
    ${KEY_DIR}/ta.key \
    <(echo -e '</tls-crypt>') \
    > ${OUTPUT_DIR}/${1}.ovpn
EOL
chmod 700 ~/client-configs/make_config.sh
cd ~/client-configs
./make_config.sh client001
ls ~/client-configs/files/

sudo nano /etc/openvpn/server/server.conf
# sample of config file https://github.com/OpenVPN/openvpn/blob/master/sample/sample-config-files/server.conf

