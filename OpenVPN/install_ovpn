sudo apt update && apt upgrade -y
sudo apt install -y openvpn easy-rsa
mkdir ~/easy-rsa
ln -s /usr/share/easy-rsa/* ~/easy-rsa/
sudo chown $USER ~/easy-rsa
chmod 700 ~/easy-rsa

cat > ~/easy-rsa/vars << EOL
set_var EASYRSA_ALGO "ec"
set_var EASYRSA_DIGEST "sha512"
EOL
cd ~/easy-rsa
~/easy-rsa/easyrsa init-pki
~/easy-rsa/easyrsa build-ca

~/easy-rsa/easyrsa gen-req $(uname -n) nopass
cp ~/easy-rsa/pki/private/$(uname -n).key /etc/openvpn/server/
~/easy-rsa/easyrsa sign-req server $(uname -n)
cp ~/easy-rsa/pki/issued/$(uname -n).crt /etc/openvpn/server
cp ~/easy-rsa/pki/ca.crt /etc/openvpn/server
openvpn --genkey secret ta.key
cp ta.key /etc/openvpn/server
# check keys SRV-VPN.crt  SRV-VPN.key  ca.crt ta.key
sudo ls /etc/openvpn/server

mkdir -p ~/client-configs/keys
chmod -R 700 ~/client-configs
cd ~/easy-rsa
./easyrsa gen-req client001 nopass
cp ~/easy-rsa/pki/private/client001.key ~/client-configs/keys/
./easyrsa sign-req client client001
cp ~/easy-rsa/ta.key ~/client-configs/keys/
cp /etc/openvpn/server/ca.crt ~/client-configs/keys/
cp ~/easy-rsa/pki/issued/client001.crt ~/client-configs/keys/
sudo chown $USER.$USER ~/client-configs/keys/*
mkdir -p ~/client-configs/files
echo " " > ~/client-configs/base.conf
# config file https://github.com/OpenVPN/openvpn/blob/master/sample/sample-config-files/client.conf
cat >  ~/client-configs/make_config.sh << EOL
#!/bin/bash
# First argument: Client identifier
KEY_DIR=~/client-configs/keys
OUTPUT_DIR=~/client-configs/files
BASE_CONFIG=~/client-configs/base.conf
cat ${BASE_CONFIG} \
    <(echo -e '<ca>') \
    ${KEY_DIR}/ca.crt \
    <(echo -e '</ca>\n<cert>') \
    ${KEY_DIR}/${1}.crt \
    <(echo -e '</cert>\n<key>') \
    ${KEY_DIR}/${1}.key \
    <(echo -e '</key>\n<tls-crypt>') \
    ${KEY_DIR}/ta.key \
    <(echo -e '</tls-crypt>') \
    > ${OUTPUT_DIR}/${1}.ovpn
EOL
chmod 700 ~/client-configs/make_config.sh
cd ~/client-configs
./make_config.sh client001
ls ~/client-configs/files/

# curl -L https://github.com/OpenVPN/openvpn/blob/master/sample/sample-config-files/server.conf -o /etc/openvpn/server/server.conf
sed -i '/;tls-auth ta.key 0 # This file is secret/a tls-crypt ta.key' /etc/openvpn/server/server.conf
sed -i '/^;data-ciphers/a ;cipher AES-256-CBC\ncipher AES-256-GCM\nauth SHA256' /etc/openvpn/server/server.conf
sed -i 's/^dh dh2048.pem$/;dh dh2048.pem/' /etc/openvpn/server/server.conf
sed -i '/^;dh dh2048.pem/a dh none' /etc/openvpn/server/server.conf
sed -i 's/^;user openvpn/user nobody/' /etc/openvpn/server/server.conf
sed -i 's/^;group openvpn/group nogroup/' /etc/openvpn/server/server.conf
sed -i 's/^cert server.crt/cert eventlog.cert/' /etc/openvpn/server/server.conf
sed -i 's/^key server.key/key eventlog.key/' /etc/openvpn/server/server.conf
sed -i 's/^;push "route 192.168.20.0 255.255.255.0"/;push "route 172.16.240.0 255.255.255.0"/' /etc/openvpn/server/server.conf

systemctl -f enable openvpn-eventlog@eventlog.service
systemctl start openvpn-eventlog@eventlog.service
systemctl status openvpn-eventlog@eventlog.service


# Windows10 OpenVPN client https://openvpn.net/community-downloads/
# https://github.com/hwdsl2/openvpn-install/blob/master/README.md
# https://github.com/Nyr/openvpn-install
